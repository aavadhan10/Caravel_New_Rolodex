# Legal Domains Knowledge Base
# This file contains the domain expertise definitions for better matching

# Define legal domains and related terms/keywords for each domain
LEGAL_DOMAINS = {
    "Administrative Law": [
        "agencies", "commissions", "regulations", "compliance", "regulatory", 
        "administrative bodies", "administrative agency", "regulatory compliance", 
        "rule-making", "administrative hearing", "administrative law judge", "ALJ",
        "FTC", "SEC", "FDIC", "Federal Reserve", "regulatory authority"
    ],
    
    "Aviation Law": [
        "aircraft", "aviation", "airline", "airliner", "FAA", "pilots", "charter", 
        "aerospace", "airport", "aircraft manufacturer", "crash", "plane", "airline regulation",
        "aircraft liability", "aviation accident", "air carrier"
    ],
    
    "Banking & Finance": [
        "banking", "finance", "banks", "financial", "bank holding", "commercial paper", 
        "secured financing", "UCC", "financial institution", "lending", "loan", "credit", 
        "financial services", "financial regulation", "consumer finance", "banking compliance",
        "financial markets", "investment", "capital markets", "banking transactions"
    ],
    
    "Bankruptcy Law": [
        "bankruptcy", "creditors", "debtors", "reorganization", "Chapter 11", "Chapter 7",
        "Chapter 13", "work-out", "debt restructuring", "insolvency", "liquidation", 
        "debtor-in-possession", "creditor's rights", "bankruptcy court", "bankruptcy trustee",
        "automatic stay", "discharge of debt", "bankruptcy protection"
    ],
    
    "Civil Litigation": [
        "litigation", "trial", "civil", "lawsuit", "settlement", "courtroom", "advocacy",
        "pleadings", "discovery", "depositions", "interrogatories", "motions", "appeals",
        "civil procedure", "evidence", "damages", "injunction", "jury trial", "bench trial"
    ],
    
    "Personal Injury": [
        "personal injury", "injury", "damages", "compensation", "accidents", "negligence", 
        "medical experts", "bodily injury", "wrongful death", "product liability", 
        "premises liability", "automobile accident", "slip and fall", "medical malpractice",
        "catastrophic injury", "pain and suffering", "lost wages", "physical therapy"
    ],
    
    "Insurance Defense": [
        "insurance", "insurers", "risk management", "claims", "defense", "liability coverage",
        "policy", "premium", "claim investigation", "claim denial", "bad faith", "coverage dispute",
        "policy exclusion", "subrogation", "deductible", "indemnification", "insurance litigation"
    ],
    
    "Products Liability": [
        "products liability", "defective", "failure to warn", "asbestos", "negligence", 
        "strict liability", "breach of warranty", "design defect", "manufacturing defect",
        "warning defect", "product recall", "dangerous product", "product safety", 
        "consumer product", "pharmaceutical liability", "toxic tort", "mass tort"
    ],
    
    "Complex Litigation": [
        "class action", "mass tort", "multiple parties", "multiple causes", "jurisdictions",
        "multidistrict litigation", "MDL", "consolidation", "bellwether trial", 
        "complex case management", "aggregate litigation", "representative action",
        "CAFA", "coordination proceedings", "complex discovery"
    ],
    
    "Civil Rights": [
        "civil rights", "discrimination", "EEOC", "equal opportunity", "harassment", 
        "public accommodation", "constitutional rights", "civil liberties", "Section 1983",
        "ADA", "voting rights", "housing discrimination", "equal protection", "due process",
        "first amendment", "free speech", "police misconduct", "prisoner rights"
    ],
    
    "Commercial Transactions": [
        "commercial", "uniform commercial code", "UCC", "mercantile", "sales", "leasing", 
        "transfer of funds", "bills of lading", "secured transactions", "commercial contracts",
        "warranties", "distribution agreements", "supply agreements", "franchise agreements",
        "vendor contracts", "purchase agreements", "commercial leases", "sale of goods"
    ],
    
    "Communications Law": [
        "communications", "media", "libel", "slander", "privacy rights", "first amendment", "FCC",
        "telecommunications", "broadcasting", "internet law", "social media", "wireless",
        "spectrum", "net neutrality", "cybersecurity", "data privacy", "TCPA", "COPA"
    ],
    
    "Construction Law": [
        "construction", "building", "developers", "contractors", "subcontractors",
        "construction defect", "mechanic's lien", "construction contracts", "surety bonds",
        "design professional", "architect", "engineer", "building code", "project development",
        "construction delay", "cost overrun", "construction litigation", "construction arbitration"
    ],
    
    "Corporate Law": [
        "corporate", "business transactions", "joint ventures", "mergers", "acquisitions", 
        "securities", "venture capital", "investment banking", "corporate governance",
        "shareholders", "board of directors", "fiduciary duty", "corporate formation",
        "bylaws", "corporate finance", "private equity", "IPO", "due diligence", "M&A"
    ],
    
    "Criminal Law": [
        "criminal", "prosecution", "defense", "FBI", "DEA", "misdemeanor", "felony", 
        "drug charges", "DUI", "white collar crime", "search and seizure", "Miranda rights",
        "arraignment", "bail", "plea bargain", "sentencing", "probation", "parole",
        "criminal procedure", "criminal trial", "criminal appeals", "habeas corpus"
    ],
    
    "Education Law": [
        "education", "schools", "K-12", "higher education", "tenure", "Department of Education", 
        "Title IX", "FERPA", "IDEA", "special education", "IEP", "student discipline",
        "education policy", "school funding", "school districts", "college", "university",
        "academic freedom", "student rights", "teacher contracts", "school liability"
    ],
    
    "Elder Law": [
        "elder", "retirement", "nursing home", "Medicare", "Medicaid", "healthcare directives", 
        "aging", "senior citizens", "long-term care", "guardianship", "conservatorship",
        "elder abuse", "retirement planning", "social security", "power of attorney",
        "end-of-life care", "elder protection", "elderly rights", "senior housing"
    ],
    
    "Employee Benefits": [
        "employee benefits", "retirement", "401k", "403b", "health benefits", "compensation", 
        "stock options", "ERISA", "pension", "profit sharing", "welfare plans", "cafeteria plans",
        "health insurance", "life insurance", "disability insurance", "deferred compensation",
        "fringe benefits", "equity compensation", "executive compensation"
    ],
    
    "Entertainment/Sports Law": [
    "entertainment", "sports", "athletes", "endorsement", "marketing agreements", 
    "on-air personalities", "film", "television", "music", "publishing",
    "entertainment copyright", "talent agreements", "rights acquisition", "royalties",
    "sports leagues", "athlete representation", "sponsorship", "media rights",
    "entertainment licensing", "performance contracts", "entertainment industry",
    "sports contract", "celebrity", "talent", "performer", "broadcasting rights"
],
    
    "Employment & Labor Law": [
        "employment", "labor", "unfair labor practices", "collective bargaining", 
        "discrimination", "wrongful discharge", "EEOC", "NLRB", "OSHA", "harassment",
        "wage and hour", "FLSA", "ADA", "FMLA", "Title VII", "workplace safety",
        "unions", "labor relations", "non-compete", "employment contracts", "whistleblower"
    ],
    
    "Environmental Law": [
        "environmental", "EPA", "permits", "clean up", "contamination", "land", "industrial", 
        "manufacturing", "Clean Air Act", "Clean Water Act", "CERCLA", "RCRA", "Superfund",
        "hazardous waste", "toxic substances", "emissions", "pollution", "environmental impact",
        "environmental compliance", "natural resources", "climate change", "wetlands"
    ],
    
    "Family Law": [
        "family", "marriage", "divorce", "custody", "support", "visitation", "child", 
        "spouse", "alimony", "prenuptial", "marital property", "child support", "adoption",
        "surrogacy", "domestic violence", "paternity", "guardianship", "separation",
        "annulment", "family court", "mediation", "parental rights", "custody evaluation"
    ],
    
    "Government Relations": [
        "government relations", "lobbying", "legislation", "administrative rulemaking", 
        "influence", "policy", "regulatory affairs", "legislative process", "congressional",
        "state legislature", "local government", "political law", "campaign finance",
        "election law", "government contracts", "public policy", "government ethics"
    ],
    
    "Health Care Law": [
        "healthcare", "medical", "hospitals", "clinics", "physicians", "insurance", 
        "managed care", "regulatory", "HIPAA", "healthcare compliance", "Medicare fraud",
        "Medicaid fraud", "Stark Law", "Anti-Kickback", "healthcare transactions",
        "healthcare licenses", "medical licensure", "telemedicine", "health information",
        "patient rights", "healthcare reform", "healthcare policy", "healthcare regulation"
    ],
    
    "Immigration": [
        "immigration", "foreigners", "aliens", "citizenship", "deportation", "naturalization", 
        "USCIS", "visa", "green card", "permanent residence", "asylum", "refugee", "H-1B",
        "F-1", "J-1", "employment-based", "family-based", "I-9 compliance", "E-Verify",
        "immigration court", "removal proceedings", "immigration reform", "DACA"
    ],
    
    "Intellectual Property": [
    "intellectual property", "IP", "copyright", "trademark", "patent", "licensing", 
    "trade secrets", "USPTO", "infringement", "intellectual asset", "technology transfer",
    "software", "DMCA", "fair use", "patent application", "trademark registration",
    "IP portfolio", "IP litigation", "IP prosecution", "IP management", "inventor",
    "technology licensing", "software licensing", "tech IP", "code"
],
    
    "International Practice": [
        "international", "foreign", "global", "cross-border", "multinational", "overseas",
        "international trade", "international finance", "international arbitration",
        "international treaties", "international tax", "foreign investment", "FCPA",
        "extraterritorial", "international corporate", "international business",
        "international dispute", "comparative law", "treaty", "international commercial"
    ],
    
    "Medical Malpractice": [
        "medical malpractice", "standard of care", "misdiagnosis", "physician", "dentist", 
        "hospital", "medical negligence", "informed consent", "failure to diagnose",
        "surgical error", "birth injury", "wrongful death", "medical expert witness",
        "medical records", "causation", "damages", "medical liability", "medical board"
    ],
    
    "Municipal Law": [
        "municipal", "government", "state", "local", "public sector", "public finance", 
        "municipalities", "city", "county", "town", "village", "zoning", "land use",
        "public utilities", "government contracts", "administrative law", "public works",
        "local ordinances", "municipal bonds", "public infrastructure", "public entities"
    ],
    
    "Probate & Estate Planning": [
        "probate", "trust", "estate", "wills", "estate planning", "inheritance", "executor", 
        "gift tax", "death tax", "fiduciary", "beneficiary", "intestate", "living trust",
        "revocable trust", "irrevocable trust", "testamentary", "power of attorney",
        "living will", "advance directive", "estate tax", "wealth transfer", "succession"
    ],
    
    "Real Estate": [
        "real estate", "property", "lease", "title", "mortgage", "lending", "commercial property", 
        "condemnation", "eminent domain", "landlord", "tenant", "easement", "zoning",
        "development", "land use", "real property", "conveyance", "closing", "foreclosure",
        "real estate transactions", "real estate finance", "property management", "REIT"
    ],
    
    "Securities Law": [
        "securities", "investments", "bonds", "stocks", "SEC", "public offerings", 
        "private placements", "blue sky", "capital", "securities regulation", "securities fraud",
        "insider trading", "Regulation D", "IPO", "registration", "exempt offerings",
        "investment advisers", "broker-dealers", "FINRA", "securities exchange"
    ],
    
    "Tax Law": [
        "tax", "IRS", "income tax", "tax planning", "tax-exempt", "tax consequences",
        "corporate tax", "partnership tax", "individual tax", "estate tax", "gift tax",
        "international tax", "state and local tax", "SALT", "tax controversy", "tax compliance",
        "tax regulations", "tax credits", "tax deductions", "tax audit", "tax litigation"
    ],
    
    "Tribal/Indian Law": [
        "tribal", "indian", "native american", "tribe", "reservation", "Bureau of Indian Affairs", 
        "sovereign", "Indian Child Welfare Act", "tribal court", "treaty rights", "tribal sovereignty",
        "tribal government", "Native lands", "Indian gaming", "cultural preservation",
        "tribal constitution", "aboriginal rights", "tribal enterprises", "tribal resources"
    ],
    
    "Workers' Compensation": [
        "workers' compensation", "industrial injury", "workplace injury", "occupational disease", 
        "safety programs", "work-related", "workers' comp", "work injuries", "disability benefits",
        "return to work", "vocational rehabilitation", "permanent disability", "temporary disability",
        "workers' comp claim", "workers' comp insurance", "employer liability", "exclusive remedy"
    ]
    "Technology Law": [
    "technology", "software", "SaaS", "cloud computing", "tech", "IT contracts",
    "software licensing", "technology agreements", "technology transactions", 
    "tech startups", "software development", "SaaS contracts", "technology licensing",
    "software as a service", "technology vendors", "IT procurement", "tech licensing",
    "digital services", "technology compliance", "data licensing", "tech contracts",
    "software agreements", "technology services", "digital platforms"
]
}

# Function to determine if a query matches a specific legal domain
def domain_matches(query, domain_name, domain_terms):
    """
    Determines if and how strongly a query matches a specific legal domain
    
    Args:
        query (str): The search query
        domain_name (str): Name of the legal domain
        domain_terms (list): List of terms related to this domain
        
    Returns:
        dict: Object with matched status and match strength
    """
    lower_query = query.lower()
    query_words = set(lower_query.split())
    
    # Direct domain match
    if domain_name.lower() in lower_query:
        return {"matched": True, "strength": 1.0}
    
    # Check for exact matches of domain terms
    matched_terms = []
    for term in domain_terms:
        if term.lower() in lower_query:
            matched_terms.append(term)
    
    if matched_terms:
        # Calculate match strength based on number of matches and specificity
        match_strength = min(0.9, 0.3 + (len(matched_terms) / len(domain_terms)) * 0.6)
        
        # Increase strength for specialized multi-word terms
        specialized_matches = [term for term in matched_terms if len(term.split()) > 1]
        if specialized_matches:
            match_strength += min(0.1, len(specialized_matches) * 0.05)
        
        return {
            "matched": True,
            "strength": match_strength,
            "matched_terms": matched_terms
        }
    
    return {"matched": False}

# Function to identify all relevant domains for a query
def identify_query_domains(query):
    """
    Identifies all relevant legal domains for a query with match strengths
    
    Args:
        query (str): The search query
        
    Returns:
        dict: Domain names mapped to match strength values
    """
    domain_scores = {}
    
    for domain_name, domain_terms in LEGAL_DOMAINS.items():
        match = domain_matches(query, domain_name, domain_terms)
        if match["matched"]:
            domain_scores[domain_name] = match["strength"]
    
    return domain_scores
    
# Function to determine if a lawyer's skills match the required domains
def evaluate_domain_expertise(lawyer_skills, query_domains):
    """
    Evaluates how well a lawyer's skills match the required domains from a query
    
    Args:
        lawyer_skills (dict): Dictionary of lawyer's skills and values
        query_domains (dict): Dictionary of domains and match strengths from query
        
    Returns:
        dict: Score information including total score and matched domains
    """
    domain_matches = {}
    total_score = 0
    has_specific_domain_expertise = False
    
    # For each domain needed by the query
    for domain_name, domain_importance in query_domains.items():
        domain_score = 0
        matched_skills = []
        
        # Check if any of the lawyer's skills match this domain
        for skill_name, skill_value in lawyer_skills.items():
            skill_lower = skill_name.lower()
            
            # Check if the skill directly references the domain
            if domain_name.lower() in skill_lower:
                # Direct domain match in skill - high relevance
                skill_score = skill_value * 3.0
                domain_score += skill_score
                matched_skills.append({"skill": skill_name, "value": skill_value, "score": skill_score})
                has_specific_domain_expertise = True
                continue
                
            # Check if skill matches any domain terms
            domain_terms = LEGAL_DOMAINS[domain_name]
            for term in domain_terms:
                if term.lower() in skill_lower:
                    # Domain term match in skill
                    skill_score = skill_value * 1.5
                    domain_score += skill_score
                    matched_skills.append({"skill": skill_name, "value": skill_value, "score": skill_score})
                    has_specific_domain_expertise = True
                    break
        
        # Calculate the weighted score for this domain
        weighted_domain_score = domain_score * domain_importance
        
        if domain_score > 0:
            domain_matches[domain_name] = {
                "domain_score": domain_score,
                "domain_importance": domain_importance,
                "weighted_score": weighted_domain_score,
                "matched_skills": matched_skills
            }
            
            total_score += weighted_domain_score
    
    return {
        "total_score": total_score,
        "domain_matches": domain_matches,
        "has_specific_domain_expertise": has_specific_domain_expertise
    }

# Main function to match lawyers to a query based on legal domain expertise
def match_lawyers_with_domain_expertise(data, query, top_n=5):
    """
    Matches lawyers to a query with emphasis on specific legal domain expertise
    
    Args:
        data (dict): The lawyer data structure
        query (str): The search query
        top_n (int): Number of top matches to return
        
    Returns:
        list: Top N lawyer matches with scores and match details
    """
    if not data:
        return []
    
    # Identify which legal domains are relevant to this query
    query_domains = identify_query_domains(query)
    
    # If no domains were identified, fall back to keyword matching
    if not query_domains:
        return fallback_keyword_matching(data, query, top_n)
    
    # Calculate match scores for each lawyer
    matches = []
    excluded_users = ["Ankita", "Test", "Tania"]
    
    for lawyer in data['lawyers']:
        # Skip test users
        if any(excluded_name in lawyer['name'] for excluded_name in excluded_users):
            continue
            
        # Evaluate how well this lawyer's skills match the required domains
        expertise_evaluation = evaluate_domain_expertise(lawyer['skills'], query_domains)
        score = expertise_evaluation["total_score"]
        
        if score > 0:
            # Identify which skills matched to create the top matched skills list
            all_matched_skills = []
            for domain_info in expertise_evaluation["domain_matches"].values():
                all_matched_skills.extend(domain_info["matched_skills"])
                
            # Sort by score and take top 5
            sorted_skills = sorted(all_matched_skills, key=lambda x: x["score"], reverse=True)
            unique_skills = []
            unique_skill_names = set()
            
            for skill in sorted_skills:
                if skill["skill"] not in unique_skill_names:
                    unique_skill_names.add(skill["skill"])
                    unique_skills.append({"skill": skill["skill"], "value": skill["value"]})
                    if len(unique_skills) >= 5:
                        break
            
            matches.append({
                'lawyer': lawyer,
                'score': score,
                'matched_skills': unique_skills,
                'matched_domains': list(expertise_evaluation["domain_matches"].keys()),
                'has_domain_expertise': expertise_evaluation["has_specific_domain_expertise"]
            })
    
    # Sort by score and return top N
    return sorted(matches, key=lambda x: x['score'], reverse=True)[:top_n]

# Fallback method for when no domains are matched
def fallback_keyword_matching(data, query, top_n=5):
    """
    Fallback method when no domains match - uses simple keyword matching
    
    Args:
        data (dict): The lawyer data structure
        query (str): The search query
        top_n (int): Number of top matches to return
        
    Returns:
        list: Top N lawyer matches with scores and match details
    """
    # Basic implementation - could be expanded
    lower_query = query.lower()
    query_words = set(lower_query.split())
    excluded_users = ["Ankita", "Test", "Tania"]
    
    matches = []
    for lawyer in data['lawyers']:
        # Skip test users
        if any(excluded_name in lawyer['name'] for excluded_name in excluded_users):
            continue
            
        score = 0
        matched_skills = []
        
        for skill, value in lawyer['skills'].items():
            skill_lower = skill.lower()
            
            # Exact skill match
            if skill_lower in lower_query:
                skill_score = value * 2.0
                score += skill_score
                matched_skills.append({"skill": skill, "value": value})
                continue
                
            # Word overlap
            skill_words = set(skill_lower.split())
            overlap = query_words.intersection(skill_words)
            
            if overlap and len(overlap) / len(skill_words) >= 0.5:
                skill_score = value * 1.0
                score += skill_score
                matched_skills.append({"skill": skill, "value": value})
        
        if score > 0:
            sorted_skills = sorted(matched_skills, key=lambda x: x["value"], reverse=True)[:5]
            matches.append({
                'lawyer': lawyer,
                'score': score,
                'matched_skills': sorted_skills,
                'has_domain_expertise': False
            })
    
    return sorted(matches, key=lambda x: x['score'], reverse=True)[:top_n]
